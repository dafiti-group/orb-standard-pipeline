description: |
  Used to update the ncharts repository to k8s deployment
  Needs:
    context: [DEFAULT]
parameters:
  gitops:
    type: string
    default: ncharts
  deployment_file:
    type: string
  version:
    type: string
    default: ""
    description: The commit hash to rollback your deployment use <<pipeline.parameters.rollback>>
executor: small
steps:
  - when:
    condition:
      equal: [true, <<parameters.rollback>>]
      steps:
        - checkout
        - aws-ecr/ecr-login
        - run:
            name: Validating version hash to rollback
            environment:
              PARAMETER_VERSION: <<parameters.version>>
            command: <<include(scripts/validate-hash.sh)>>
  - name: check image hash
    command: <<include(scripts/validate-hash.sh)>>
  - config_git
  - clone_ncharts:
      ncharts: <<parameters.gitops>>
  - name: change image tag and push
    command: |
      yq -i '.app.image.tag = strenv(PARAMETER_VERSION)' <<parameters.deployment_file>>
      git commit -a -m "${CIRCLE_PROJECT_REPONAME} change image tag in: " <<parameters.deployment_file>>
      git push
  - slack/notify:
      event: fail
      custom: <<include(templates/fail.json)>>
  - slack/notify:
      event: pass
      custom: <<include(templates/success.json)>>
