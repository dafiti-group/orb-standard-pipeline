description: |
  Default instana notify.
  Needs:
    context: [DEFAULT, (LIVE|QA)]
parameters:
  service_name:
    type: string
    description: Name of you application service in instana apm
    default: ${CIRCLE_PROJECT_REPONAME}.${ENV_SHORT}.dafiti.local
  release_scope:
    type: string
    description: Default protocol service https://circleci.com/developer/orbs/orb/instana/pipeline-feedback?version=2.0.3#commands-create_release
    default: |
      {
        "services": [
          {"name": "${LOCAL_SERVICE_NAME}"}
        ]
      }
executor: instana
steps:
  - run:
      name: Build release scope
      environment:
        LOCAL_SERVICE_NAME: <<parameters.service_name>>
        LOCAL_RELEASE_SCOPE: <<parameters.release_scope>>
      command: <<include(scripts/create_release.sh)>>
  - pipeline-feedback/create_release:
      release_name: "${ENV_SHORT}-${CIRCLE_PROJECT_REPONAME} commit ${CIRCLE_SHA1}"
      release_scope: ${INTERNAL_INTERPOLATED_JSON}
  - slack/notify:
      event: fail
      custom: <<include(templates/fail.json)>>
