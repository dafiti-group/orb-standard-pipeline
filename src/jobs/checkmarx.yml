description: |
  This job will be the new checkmarx context.
  Needs
    context: [DEFAULT]
executor: cxflow/default
circleci_ip_ranges: true
parameters:
  branch_head_name:
    type: string
    default: main
    description: |
      The HEAD branch name to be skipped as a target to be deleted from checkmarx project
  project_type:
    type: enum
    default: new
    description: The project type
    enum:
      - legacy
      - new
  no-output-timeout:
    type: string
    default: 120m
    description: used to handle checkmax run timeout
steps:
  - run:
      name: install image dependencies
      command: apk add curl jq git openssl || exit 1
  - checkout
  - run:
      name: Checkmarx branching validation, creation, and delete steps.
      environment:
        HEAD_BRANCH_NAME: <<parameters.branch_head_name>>
        PROJECT_TYPE: <<parameters.project_type>>
        PARAMETER_METHODE: "project_exists"
      command: <<include(scripts/checkmarx.sh)>>
  - run:
      name: Checkmarx Scan
      environment:
        HEAD_BRANCH_NAME: <<parameters.branch_head_name>>
        PROJECT_TYPE: <<parameters.project_type>>
        PARAMETER_METHODE: "project_exists"
      command: <<include(scripts/checkmarx-scan.sh)>>
  - run:
      name: Checkmarx delete last scan ID.
      when: on_fail
      environment:
        PARAMETER_METHODE: "get_last_scan_id"
      command: <<include(scripts/checkmarx.sh)>>
  - slack/notify:
      event: fail
      custom: <<include(templates/fail.json)>>
